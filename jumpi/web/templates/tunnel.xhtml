{% extends "base.xhtml" %}

{% block script %}
<script type="text/javascript">
$(document).ready(function() {
    var loader = {}

    $('#add_tunnel_form').hide();
    $('#add_tunnel_button').click(function() {
        $('#add_tunnel_form').toggle();
    });

    $('.form-inline').hide();
    $('.tunnel-edit').hide();
    $('.tunnel-link').click(function() {
        var data = {dbid: $(this).attr("dbid")};
        var index = $(this).attr("index");

        if(loader[index] != "true") {
            $.getJSON("{{ url_for('tunnel.get_permissions') }}", data, function(data) {
                $("#used-"+index).empty();
                $.each(data.permissions, function(i, value) {
                    $('<option/>').val(value.id).text(value.text).appendTo("#used-"+index);
                    $("#avail-"+index+" option[value='"+value.id+"']").remove();
                });
                loader[index] = "true";
                $("#spinner-"+index).hide();
                $("#form-"+index).show();
            });
        }

        $(this).next().toggle();
    });

    $('.save-btn').click(function() {
        if(loader[$(this).attr("index")] != "true") {
            return;
        }

        var perms = [];
        $("#used-"+$(this).attr("index")+" option").each(function() {
            perms.push($(this).val());
        });
        var data = {dbid: $(this).attr("dbid"), perms: perms}
        $.post("{{ url_for('tunnel.save_permissions') }}", data, function(data) {
            window.location.href = "{{ url_for('tunnel.index') }}";
        });
    });

    $('.del-btn').click(function() {
        var c = confirm("Are you sure you want to delete this tunnel?");
        if (c) {
            $.post("{{ url_for('tunnel.delete_tunnel') }}", {id: $(this).attr("dbid")}, function(data) {
                window.location.href = "{{ url_for('tunnel.index') }}";
            });
        }
    });

    $('.add-btn').click(function() {
        var index = $(this).attr("index");
        $("#avail-"+index+" option:selected").remove().appendTo("#used-"+index);
    });

    $('.sub-btn').click(function() {
        var index = $(this).attr("index");
        $("#used-"+index+" option:selected").remove().appendTo("#avail-"+index);
    });
});
</script>
{% endblock %}

{% block content %}

<div class="panel panel-default">
    <div class="panel-heading">
        <strong>Tunnels</strong>
    </div>
    <div class="panel-body">
        <p><small>This is a list of SSH tunnels. Per default users are not allowed to open SSH tunnels. You can specify and allow tunnels on this page.</small></p>
        <button type="button" class="btn btn-success btn-xs" id="add_tunnel_button">Add tunnel</button>
    </div>

    <div class="list-group">
    {% for tunnel in tunnels %}
    <a href="#" class="list-group-item tunnel-link" dbid="{{ tunnel.id }}" index="{{ loop.index }}"><span class="fa-stack"><i class="fa fa-exchange fa-stack-1x"></i></span>&nbsp;&nbsp;<strong>{{ tunnel.destination }}:{{ tunnel.port }}</strong></a>
        <div class="list-group-item tunnel-edit">
            <button type="button" class="btn btn-danger btn-xs pull-right del-btn" dbid="{{ tunnel.id }}">delete</button>
            <button type="button" class="btn btn-success btn-xs pull-right save-btn" style="margin-right: 7px;" dbid="{{ tunnel.id }}" index="{{ loop.index }}">save</button>
            <h4>User permissions</h4>
            <div id="spinner-{{loop.index}}"><i class="fa fa-refresh fa-spin"></i></div>
            <form class="form-inline" role="form" id="form-{{loop.index}}">
                <div class="form-group">
                    <select class="form-control" multiple="multiple" id="avail-{{ loop.index }}">
                        {% for user in users %}
                        <option value="{{ user.id }}">{{ user.fullname }}</option>
                        {% endfor%}
                    </select>
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-default btn-xs add-btn" index="{{ loop.index }}">&gt;</button><br /><br />
                    <button type="button" class="btn btn-default btn-xs sub-btn" index="{{ loop.index }}">&lt;</button>
                </div>
                <div class="form-group">
                    <select class="form-control" multiple="multiple" id="used-{{ loop.index }}">
                    </select>
                </div>
            </form>
            &nbsp;
        </div>
    {% endfor %}
    </div>
</div>

<div class="panel panel-default" id="add_tunnel_form">
    <div class="panel-heading">
        <strong>Add tunnel</strong>
    </div>
    <div class="panel-body">
        <form class="form-horizontal" role="form" method="post" action="{{ url_for('tunnel.add_tunnel') }}">
            <fieldset>
                <div class="form-group">
                    <label for="inputDestination" class="col-lg-2 control-label">Destination</label>
                    <div class="col-lg-10">
                        <input type="text" class="form-control" id="inputDestination" name="destination" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputPort" class="col-lg-2 control-label">Port</label>
                    <div class="col-lg-10">
                        <input type="text" class="form-control" id="inputPort" name="port" />
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-lg-10 col-lg-offset-2">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </div>
            </fieldset>
        </form>
    </div>
</div>
{% endblock %}
