{% extends "base.xhtml" %}

{% block script %}
<script type="text/javascript">
$(document).ready(function() {
    var loader = {}

    $('.target-edit').hide();
    $('.target-link').click(function() {
        var data = {dbid: $(this).attr("dbid")};
        var index = $(this).attr("index");

        if(loader[index] != "true") {
            $.getJSON("{{ url_for('target.get_permissions') }}", data, function(data) {
                $("#used-"+index).empty();
                $.each(data.permissions, function(i, value) {
                    $('<option/>').val(value.id).text(value.text).appendTo("#used-"+index);
                    $("#avail-"+index+" option[value='"+value.id+"']").remove();
                });
                loader[index] = "true";
            });
        }

        $(this).next().toggle();
    });

    $('.save-btn').click(function() {
        var perms = [];
        $("#used-"+$(this).attr("index")+" option").each(function() {
            perms.push($(this).val());
        });
        var data = {dbid: $(this).attr("dbid"), perms: perms}
        $.post("{{ url_for('target.save_permissions') }}", data, function(data) {
            window.location.href = "{{ url_for('target.index') }}";
        });
    });

    $('.del-btn').click(function() {
        var c = confirm("Are you sure you want to delete this target?");
        if (c) {
            $.post("{{ url_for('target.delete_target') }}", {id: $(this).attr("dbid")}, function(data) {
                window.location.href = "{{ url_for('target.index') }}";
            });
        }
    });

    $('.add-btn').click(function() {
        var index = $(this).attr("index");
        $("#avail-"+index+" option:selected").remove().appendTo("#used-"+index);
    });

    $('.sub-btn').click(function() {
        var index = $(this).attr("index");
        $("#used-"+index+" option:selected").remove().appendTo("#avail-"+index);
    });
});
</script>
{% endblock %}

{% block content %}
<div class="list-group">
{% for target in targets %}
<a href="#" class="list-group-item target-link" dbid="{{ target.id }}" index="{{ loop.index }}"><strong>{{ target.id }}</strong> <em>(Port: {{ target.port }})</em></a>
    <div class="list-group-item target-edit">
        <button type="button" class="btn btn-danger btn-xs pull-right del-btn" dbid="{{ target.id }}">delete</button>
        <button type="button" class="btn btn-success btn-xs pull-right save-btn" style="margin-right: 7px;" dbid="{{ target.id }}" index="{{ loop.index }}">save</button>
        <form class="form-inline" role="form">
            <h4>User permissions</h4>
            <div class="form-group">
                <select class="form-control" multiple="multiple" id="avail-{{ loop.index }}">
                    {% for user in users %}
                    <option value="{{ user.id }}">{{ user.fullname }}</option>
                    {% endfor%}
                </select>
            </div>
            <div class="form-group">
                <button type="button" class="btn btn-default btn-xs add-btn" index="{{ loop.index }}">&gt;</button><br /><br />
                <button type="button" class="btn btn-default btn-xs sub-btn" index="{{ loop.index }}">&lt;</button>
            </div>
            <div class="form-group">
                <select class="form-control" multiple="multiple" id="used-{{ loop.index }}">
                </select>
            </div>
        </form>
        &nbsp;
    </div>
{% endfor %}
</div>

<div class="panel panel-default">
    <div class="panel-heading">
        <strong>Add target</strong>
    </div>
    <div class="panel-body">
        <form class="form-horizontal" role="form" method="post" action="{{ url_for('target.add_target') }}">
            <fieldset>
                <div class="form-group">
                    <label for="inputUsername" class="col-lg-2 control-label">Username</label>
                    <div class="col-lg-10">
                        <input type="text" class="form-control" id="inputUsername" name="username" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputTarget" class="col-lg-2 control-label">Hostname/IP</label>
                    <div class="col-lg-10">
                        <input type="text" class="form-control" id="inputTarget" name="target" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputPort" class="col-lg-2 control-label">Port</label>
                    <div class="col-lg-10">
                        <input type="text" class="form-control" id="inputPort" name="port" />
                    </div>
                </div>
                <div class="form-group">
                    <label for="inputType" class="col-lg-2 control-label">Login Type</label>
                    <div class="col-lg-10">
                        <select class="form-control" id="inputType" name="type">
                            <option value="password">Password</option>
                            <option value="key">RSA/DSA Key</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-lg-10 col-lg-offset-2">
                        <textarea class="form-control" rows="3" id="inputKey" name="key"></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-lg-10 col-lg-offset-2">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </div>
            </fieldset>
        </form>
    </div>
</div>
{% endblock %}
